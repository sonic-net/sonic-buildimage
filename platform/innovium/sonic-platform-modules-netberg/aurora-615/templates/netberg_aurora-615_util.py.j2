#!/usr/bin/env python


"""
Usage: %(scriptName)s [options] command object

options:
    -h | --help     : this help message
    -d | --debug    : run with debug mode
    -f | --force    : ignore error during installation or clean 
command:
    install     : install drivers and generate related sysfs nodes
    clean       : uninstall drivers and remove related sysfs nodes
    version     : show version
"""

import os
import commands
import sys
import getopt
import logging
import re
import time

PROJECT_NAME = 'aurora_615'
verbose = False
DEBUG = False
FORCE = 0

I2C_PREFIX = '/sys/bus/i2c/devices/'
BASE_BUS = 'i2c-0'
BASE_BUS_PATH = I2C_PREFIX + BASE_BUS

switch_install_order = [
    # 'PCA9548_0x73',
    'PCA9548_0x71_1',
    'PCA9548_0x71_2',
    'PCA9548_0x71_3',
    'PCA9548_0x71_4',
    'PCA9548_0x71_5',
    'PCA9548_0x71_6',
    'PCA9548_0x71_7',
    # 'PCA9548_0x75'
]

I2C_SWITCH_LIST = {
    # i2c switches
    'PCA9548_0x73': {
        'parent': BASE_BUS,
        'driver': 'pca9548',
        'i2caddr': '0x73',
        'path': '/sys/bus/i2c/devices/0-0073',
        'bus_map': [1, 2, 3, 4, 5, 6, 7, 8],
        'status': 'NOTINST'
    },
    # 'PCA9548_0x75': {
    #    'parent':'base',
    #    'driver':'pca9548',
    #    'i2caddr': '0x75',
    #    'path': ' ',
    #    'bus_map': [0,0,0,0,0,0,0,0],
    #    'status':'NOTINST'
    # },
    'PCA9548_0x71_1': {
        'parent': 'PCA9548_0x73',
        'parent_ch': 0,
        'driver': 'pca9548',
        'i2caddr': '0x71',
        'path': '/sys/bus/i2c/devices/1-0071',
        'bus_map': [9, 10, 11, 12, 13, 14, 15, 16],
        'status': 'NOTINST'
    },
    'PCA9548_0x71_2': {
        'parent': 'PCA9548_0x73',
        'parent_ch': 1,
        'driver': 'pca9548',
        'i2caddr': '0x71',
        'path': '/sys/bus/i2c/devices/2-0071',
        'bus_map': [17, 18, 19, 20, 21, 22, 23, 24],
        'status': 'NOTINST'
    },
    'PCA9548_0x71_3': {
        'parent': 'PCA9548_0x73',
        'parent_ch': 2,
        'driver': 'pca9548',
        'i2caddr': '0x71',
        'path': '/sys/bus/i2c/devices/3-0071',
        'bus_map': [25, 26, 27, 28, 29, 30, 31, 32],
        'status': 'NOTINST'
    },
    'PCA9548_0x71_4': {
        'parent': 'PCA9548_0x73',
        'parent_ch': 3,
        'driver': 'pca9548',
        'i2caddr': '0x71',
        'path': '/sys/bus/i2c/devices/4-0071',
        'bus_map': [33, 34, 35, 36, 37, 38, 39, 40],
        'status': 'NOTINST'
    },
    'PCA9548_0x71_5': {
        'parent': 'PCA9548_0x73',
        'parent_ch': 4,
        'driver': 'pca9548',
        'i2caddr': '0x71',
        'path': '/sys/bus/i2c/devices/5-0071',
        'bus_map': [41, 42, 43, 44, 45, 46, 47, 48],
        'status': 'NOTINST'
    },
    'PCA9548_0x71_6': {
        'parent': 'PCA9548_0x73',
        'parent_ch': 5,
        'driver': 'pca9548',
        'i2caddr': '0x71',
        'path': '/sys/bus/i2c/devices/6-0071',
        'bus_map': [49, 50, 51, 52, 53, 54, 55, 56],
        'status': 'NOTINST'
    },
    'PCA9548_0x71_7': {
        'parent': 'PCA9548_0x73',
        'parent_ch': 6,
        'driver': 'pca9548',
        'i2caddr': '0x71',
        'path': '/sys/bus/i2c/devices/7-0071',
        'bus_map': [57, 58, 59, 60, 61, 62, 63, 64],
        'status': 'NOTINST'
    }
}

SFP_GROUPS = {
    'SFP-G01': {
        "type": "SFP+",
        'number': 8,
        'parent': 'PCA9548_0x71_1',
        'channels': [0, 1, 2, 3, 4, 5, 6, 7],
        'driver': 'optoe2',
        'i2caddr': '0x50',
        'paths': ["/sys/bus/i2c/devices/9-0050", "/sys/bus/i2c/devices/10-0050",
                  "/sys/bus/i2c/devices/11-0050", "/sys/bus/i2c/devices/12-0050",
                  "/sys/bus/i2c/devices/13-0050", "/sys/bus/i2c/devices/14-0050",
                  "/sys/bus/i2c/devices/15-0050", "/sys/bus/i2c/devices/16-0050"],
        'status': 'NOTINST'
    },
    'SFP-G02': {
        "type": "SFP+",
        'number': 8,
        'parent': 'PCA9548_0x71_2',
        'channels': [0, 1, 2, 3, 4, 5, 6, 7],
        'driver': 'optoe2',
        'i2caddr': '0x50',
        'paths': ["/sys/bus/i2c/devices/17-0050", "/sys/bus/i2c/devices/18-0050",
                  "/sys/bus/i2c/devices/19-0050", "/sys/bus/i2c/devices/20-0050",
                  "/sys/bus/i2c/devices/21-0050", "/sys/bus/i2c/devices/22-0050",
                  "/sys/bus/i2c/devices/23-0050", "/sys/bus/i2c/devices/24-0050"],
        'status': 'NOTINST'
    },
    'SFP-G03': {
        "type": "SFP+",
        'number': 8,
        'parent': 'PCA9548_0x71_3',
        'channels': [0, 1, 2, 3, 4, 5, 6, 7],
        'driver': 'optoe2',
        'i2caddr': '0x50',
        'paths': ["/sys/bus/i2c/devices/25-0050", "/sys/bus/i2c/devices/26-0050",
                  "/sys/bus/i2c/devices/27-0050", "/sys/bus/i2c/devices/28-0050",
                  "/sys/bus/i2c/devices/29-0050", "/sys/bus/i2c/devices/30-0050",
                  "/sys/bus/i2c/devices/31-0050", "/sys/bus/i2c/devices/32-0050"],
        'status': 'NOTINST'
    },
    'SFP-G04': {
        "type": "SFP+",
        'number': 8,
        'parent': 'PCA9548_0x71_4',
        'channels': [0, 1, 2, 3, 4, 5, 6, 7],
        'driver': 'optoe2',
        'i2caddr': '0x50',
        'paths': ["/sys/bus/i2c/devices/33-0050", "/sys/bus/i2c/devices/34-0050",
                  "/sys/bus/i2c/devices/35-0050", "/sys/bus/i2c/devices/36-0050",
                  "/sys/bus/i2c/devices/37-0050", "/sys/bus/i2c/devices/38-0050",
                  "/sys/bus/i2c/devices/39-0050", "/sys/bus/i2c/devices/40-0050"],

        'status': 'NOTINST'
    },
    'SFP-G05': {
        "type": "SFP+",
        'number': 8,
        'parent': 'PCA9548_0x71_5',
        'channels': [0, 1, 2, 3, 4, 5, 6, 7],
        'driver': 'optoe2',
        'i2caddr': '0x50',
        'paths': ["/sys/bus/i2c/devices/41-0050", "/sys/bus/i2c/devices/42-0050",
                  "/sys/bus/i2c/devices/43-0050", "/sys/bus/i2c/devices/44-0050",
                  "/sys/bus/i2c/devices/45-0050", "/sys/bus/i2c/devices/46-0050",
                  "/sys/bus/i2c/devices/47-0050", "/sys/bus/i2c/devices/48-0050"],

        'status': 'NOTINST'
    },
    'SFP-G06': {
        "type": "SFP+",
        'number': 8,
        'parent': 'PCA9548_0x71_6',
        'channels': [0, 1, 2, 3, 4, 5, 6, 7],
        'driver': 'optoe2',
        'i2caddr': '0x50',
        'paths': ["/sys/bus/i2c/devices/49-0050", "/sys/bus/i2c/devices/50-0050",
                  "/sys/bus/i2c/devices/51-0050", "/sys/bus/i2c/devices/52-0050",
                  "/sys/bus/i2c/devices/53-0050", "/sys/bus/i2c/devices/54-0050",
                  "/sys/bus/i2c/devices/55-0050", "/sys/bus/i2c/devices/56-0050"],

        'status': 'NOTINST'
    },
    'SFP-G07': {
        "type": "QSFP28",
        'number': 8,
        'parent': 'PCA9548_0x71_7',
        'channels': [0, 1, 2, 3, 4, 5, 6, 7],
        'driver': 'optoe1',
        'i2caddr': '0x50',
        'paths': ["/sys/bus/i2c/devices/57-0050", "/sys/bus/i2c/devices/58-0050",
                  "/sys/bus/i2c/devices/59-0050", "/sys/bus/i2c/devices/60-0050",
                  "/sys/bus/i2c/devices/61-0050", "/sys/bus/i2c/devices/62-0050",
                  "/sys/bus/i2c/devices/63-0050", "/sys/bus/i2c/devices/64-0050"],

        'status': 'NOTINST'
    }
}


def main():
    global DEBUG
    global args
    global FORCE

    options, args = getopt.getopt(sys.argv[1:], 'hdf', ['help',
                                                        'debug',
                                                        'force',
                                                        ])
    for opt, arg in options:
        if opt in ('-d', '--debug'):
            DEBUG = True
            logging.basicConfig(level=logging.INFO)
        elif opt in ('-f', '--force'):
            FORCE = 1
        else:
            logging.info('no option')
    for arg in args:
        if arg == 'install':
            do_install()
        elif arg == 'clean':
            do_uninstall()
        elif arg == 'version':
            show_version()

    return 0


def show_version():
    print("platform driver version: {}\n".format(PLATFORM_DRIVER_VER))


def driver_check():
    with open('/proc/modules') as modules:
        return 'x86_64_netberg_aurora' in modules.read()


def driver_install():
    print("Probbing modules...")
    os.system('modprobe i2c_dev')
    os.system('modprobe x86-64-netberg-aurora-615')
    os.system('modprobe i2c_mux_pca954x force_deselect_on_exit=1')

    return 0


def driver_uninstall():
    os.system('rmmod i2c_mux_pca954x')
    os.system('rmmod x86-64-netberg-aurora-615')
    os.system('rmmod i2c_dev')

    return 0


def install_i2c_switch():
    print("Init root I2C switch...")

    root_sw = I2C_SWITCH_LIST['PCA9548_0x73']
    os.system(
        "echo {} {} > {}/new_device".format(root_sw['driver'], root_sw['i2caddr'], BASE_BUS_PATH))

    #  make sure the root switch for sfp is installed
    time.sleep(2)

    for switch_name in switch_install_order:
        switch = I2C_SWITCH_LIST[switch_name]

        install_path = I2C_SWITCH_LIST[switch['parent']]['path']
        install_path = install_path+"/channel-{}".format(switch['parent_ch'])

        cmd = "echo {} {} > {}/new_device".format(
            switch['driver'], switch['i2caddr'], install_path)
        print(cmd)
        os.system(cmd)


def install_sfp():
    for sfp_group_name in SFP_GROUPS.keys():
        sfp_group = SFP_GROUPS[sfp_group_name]
        install_path = I2C_SWITCH_LIST[sfp_group['parent']]['path']

        for n in range(0, sfp_group['number']):
            sfp_install_path = install_path + \
                "/channel-{}".format(sfp_group['channels'][n])
            cmd = "echo {} {} > {}/new_device".format(
                sfp_group['driver'], sfp_group['i2caddr'], sfp_install_path)
            print(cmd)
            os.system(cmd)

            print("/sys/bus/i2c/devices/{}-00{}".format(
                I2C_SWITCH_LIST[sfp_group['parent']]['bus_map'][sfp_group['channels'][n]], sfp_group['i2caddr'][-2:]))


def uninstall_sfp():
    for sfp_group_name in SFP_GROUPS.keys():
        sfp_group = SFP_GROUPS[sfp_group_name]

        uninst_path = I2C_SWITCH_LIST[sfp_group['parent']]['path']

        for n in range(0, sfp_group['number']):
            sfp_uninst_path = uninst_path + \
                "/channel-{}".format(sfp_group['channels'][n])
            cmd = "echo {} > {}/delete_device".format(
                sfp_group['i2caddr'], sfp_uninst_path)
            print(cmd)
            os.system(cmd)


def uninstall_i2c_switch():
    for switch_name in reversed(switch_install_order):
        switch = I2C_SWITCH_LIST[switch_name]
        uninst_path = I2C_SWITCH_LIST[switch['parent']
                                      ]['path'] + "/channel-{}".format(switch['parent_ch'])

        cmd = "echo {} > {}/delete_device".format(
            switch['i2caddr'], uninst_path)

        print(cmd)
        os.system(cmd)

    print("Uninstall root switch...")
    root_sw = I2C_SWITCH_LIST['PCA9548_0x73']
    cmd = "echo {} > {}/delete_device".format(
        root_sw['i2caddr'], BASE_BUS_PATH)
    print(cmd)
    os.system(cmd)


def set_led_control():
    cmd = "echo 1 > /sys/class/hwmon/hwmon2/device/NBA615_LED/led_fiber"
    print(cmd)
    os.system(cmd)


def device_install():
    print('Base bus is {}'.format(BASE_BUS))

    set_led_control()

    install_i2c_switch()

    # delay to make sure all switches are installed completely,
    time.sleep(1)

    install_sfp()
    return 0


def device_uninstall():
    global SFP_GROUPS
    global I2C_SWITCH_LIST

    uninstall_sfp()
    uninstall_i2c_switch()
    return 0


def do_install():
    print("Drivers installing....")
    status = driver_install()
    print("Devices installing....")
    status = device_install()
    return 0


def do_uninstall():
    print("Checking system....")
    if not device_exist():
        print(PROJECT_NAME.upper() + " has no device installed.")
    else:
        print("Removing device...")
        status = device_uninstall()
        if status:
            if FORCE == 0:
                return status

    if driver_check() == False:
        print(PROJECT_NAME.upper() + " has no driver installed.")
    else:
        print("Removing installed driver...")
        status = driver_uninstall()
        if status:
            if FORCE == 0:
                return status

    return


def device_exist():
    print("Checking devices... ")
    return os.path.isdir("/sys/bus/i2c/devices/0-0056/")


if __name__ == "__main__":
    main()

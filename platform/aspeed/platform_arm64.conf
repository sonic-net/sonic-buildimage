#!/bin/sh
# Implementation of installation behavior for Aspeed AST2700 BMC platform

echo "Preparing for Aspeed AST2700 installation..."

# Global defines
VAR_LOG=4096  # 4GB for /var/log

# SONiC filesystem definitions (must match installer/install.sh)
DOCKERFS_DIR=docker
FILESYSTEM_DOCKERFS=dockerfs.tar.gz
FILESYSTEM_SQUASHFS=fs.squashfs

# Kernel configuration
kernel_version=6.12.41+deb13-sonic-arm64
kernel_fname="/boot/vmlinuz-$kernel_version"
initrd_fname="/boot/initrd.img-$kernel_version"
fit_fname="/boot/sonic_arm64.fit"
dtb_name="ast2700-evb.dtb"  # Device tree blob filename

# Get machine configuration file location
if [ "$install_env" = "onie" ]; then
    MACH_FILE="/etc/machine.conf"
else
    MACH_FILE="/host/machine.conf"
fi

# Detect platform
if [ -f "$MACH_FILE" ]; then
    PLATFORM=`sed -n 's/^onie_platform=\(.*\)/\1/p' $MACH_FILE`
else
    # No machine.conf, assume AST2700 with full device directory name
    PLATFORM="arm64-aspeed_ast2700-r0"
    echo "Warning: machine.conf not found, assuming platform: $PLATFORM"
fi

echo "Installing SONiC from ${install_env:-unknown} on Platform $PLATFORM"

# AST2700 platform configuration
disk_interface="mmc"
mmc_bus="mmc0:0001"  # Based on kernel log: mmc0:0001 008GB1

# Device tree and FIT image configuration
fdt_fname="/usr/lib/linux-image-${kernel_version}/aspeed/${dtb_name}"
fit_conf_name="#conf-${dtb_name}"

# U-Boot memory addresses for AST2700
# Based on actual hardware memory map from bdinfo:
# - RAM: 0x400000000 - 0x47e000000 (2016 MB)
# - Reserved: 0x41b800000-0x423ffffff (136 MB), 0x42c000000-0x431bfffff (92 MB)
# - Safe addresses avoid reserved regions
# See platform/aspeed/AST2700-MEMORY-MAP.md for details
#
# Memory Layout (works for both production and installation initramfs):
#   0x403000000: Kernel (~10 MB)
#   0x440000000: Initramfs (192 MB allocated for decompression)
#                - Production initramfs: 37.4 MB compressed, 160 MB uncompressed
#                - Installation initramfs: 3-5 MB compressed, ~10 MB uncompressed
#   0x44C000000: DTB (~50 KB) - after initramfs (0x440000000 + 192 MB)
#
# IMPORTANT: Initramfs is compressed (zstd) but kernel decompresses IN PLACE
# Need space for UNCOMPRESSED size (160 MB), not compressed size (37 MB)!
#
# Memory layout (avoiding reserved regions 0x41b800000-0x423ffffff and 0x42c000000-0x431bfffff):
# fit_addr: where FIT image is loaded (temporary, ~100 MB, after reserved region 2)
# kernel_addr: where kernel is extracted from FIT (U-Boot default loadaddr)
# initrd_addr: where initrd is extracted from FIT (after reserved regions, 192 MB allocated)
# fdt_addr: where device tree blob is extracted from FIT (after initramfs space)
fit_addr=0x432000000
kernel_addr=0x403000000
initrd_addr=0x440000000
fdt_addr=0x44C000000

# U-Boot environment location
# AST2700 typically stores U-Boot env in SPI flash (MTD)
FW_ENV_DEFAULT='/dev/mtd1 0x0 0x20000 0x10000'

# Console configuration for AST2700
# AST2700 uses ttyS12 for console
CONSOLE_PORT=ttyS12
CONSOLE_SPEED=115200

# Early console for debugging
EARLYCON="earlycon=uart8250,mmio32,0x14c33b00"

# Additional kernel command line arguments
LINUX_MISC_CMD="$EARLYCON console=$CONSOLE_PORT,$CONSOLE_SPEED"

# Extra kernel command line for GRUB bootloader configuration
# This is appended to the kernel command line in the generated grub.cfg
ONIE_PLATFORM_EXTRA_CMDLINE_LINUX="$EARLYCON console=$CONSOLE_PORT,${CONSOLE_SPEED}n8"

# Get eMMC block device
# AST2700 EVB has eMMC at /dev/mmcblk0 (mmc0:0001)
get_install_device()
{
    # In build mode, there's no hardware - skip device detection
    if [ "$install_env" = "build" ]; then
        return 0
    fi

    if [ ! -z "$mmc_bus" ]; then
        for i in 0 1 2 ; do
            if $(ls -l /sys/block/mmcblk$i/device 2>/dev/null | grep -q "$mmc_bus") ; then
                echo "/dev/mmcblk$i"
                blk_dev=/dev/mmcblk$i
                disk_interface="mmc"
                echo "Selected eMMC device: $blk_dev"
                return
            fi
        done
    fi

    echo "Warning: eMMC not found. Will try installing on the same disk as ONIE."
}

get_install_device

# Configure U-Boot environment access
configure_uboot_env() {
    echo "Configuring U-Boot environment access..."

    # Check for MTD device first by parsing /proc/mtd
    # Example line: mtd1: 00020000 00010000 "u-boot-env"
    MTD_ENV_LINE=$(grep -E '"u-boot-env"|"uboot-env"' /proc/mtd 2>/dev/null || true)

    if [ -n "$MTD_ENV_LINE" ]; then
        # Parse MTD device name, size, and erasesize from /proc/mtd
        MTD_DEV=$(echo "$MTD_ENV_LINE" | awk -F: '{print $1}')
        MTD_SIZE=$(echo "$MTD_ENV_LINE" | awk '{print "0x" $2}')
        MTD_ERASESIZE=$(echo "$MTD_ENV_LINE" | awk '{print "0x" $3}')

        if [ -c "/dev/$MTD_DEV" ]; then
            FW_ENV_CONFIG="/dev/$MTD_DEV 0x0 $MTD_SIZE $MTD_ERASESIZE"
            echo "Detected U-Boot env from /proc/mtd: $FW_ENV_CONFIG"
        fi
    fi

    # If not found in MTD, try device tree
    if [ -z "$FW_ENV_CONFIG" ]; then
        DTB_HAS_ENV_BLK=$(grep -E "uboot-env|u-boot-env" /proc/mtd 2>/dev/null | sed -e 's/:.*$//' || true)
        if [ -n "$DTB_HAS_ENV_BLK" ] && [ -c "/dev/$DTB_HAS_ENV_BLK" ]; then
            PROC_ENV_FILE=$(find /proc/device-tree/ -name env_size 2>/dev/null || true)
            if [ -n "$PROC_ENV_FILE" ]; then
                UBOOT_ENV_SIZ="0x$(hd $PROC_ENV_FILE | awk 'FNR==1 {print $2 $3 $4 $5}')"
                UBOOT_ENV_ERASE_SIZ="0x$(grep -E "uboot-env|u-boot-env" /proc/mtd | awk '{print $3}')"
                if [[ -n "$UBOOT_ENV_SIZ" && -n "$UBOOT_ENV_ERASE_SIZ" ]]; then
                    FW_ENV_CONFIG="/dev/$DTB_HAS_ENV_BLK 0x00000000 $UBOOT_ENV_SIZ $UBOOT_ENV_ERASE_SIZ"
                    echo "Detected U-Boot env from device tree: $FW_ENV_CONFIG"
                fi
            fi
        fi
    fi

    # If still not found, use eMMC default location
    if [ -z "$FW_ENV_CONFIG" ]; then
        # AST2700 default: U-Boot environment on eMMC at 31.25 MB offset
        # This matches typical U-Boot configuration for eMMC devices
        FW_ENV_CONFIG="/dev/mmcblk0 0x1F40000 0x20000 0x1000"
        echo "Using default eMMC U-Boot env location: $FW_ENV_CONFIG"
    fi

    # Write configuration file
    echo "$FW_ENV_CONFIG" > /etc/fw_env.config
    echo "Created /etc/fw_env.config: $FW_ENV_CONFIG"

    # Verify fw_printenv can access the environment
    if fw_printenv bootcmd >/dev/null 2>&1; then
        echo "U-Boot environment is accessible"
    else
        echo "WARNING: Cannot access U-Boot environment. fw_printenv/fw_setenv may not work."
        echo "You may need to adjust the offset in /etc/fw_env.config"
    fi
}

# Prepare U-Boot boot menu
prepare_boot_menu() {
    echo "Sync up cache ..."
    sync
    echo "Setting up U-Boot environment for Aspeed AST2700..."

    # Configure U-Boot environment access first
    # This function detects MTD, device tree, or uses eMMC default
    configure_uboot_env

    image_name=${image_dir}${kernel_fname}
    initrd_name=${image_dir}${initrd_fname}
    fdt_name=${image_dir}${fdt_fname}
    fit_name=${image_dir}${fit_fname}

    # Get partition UUID for the installation target (single SONiC-OS partition)
    uuid=$(blkid | grep "$demo_volume_label" | sed -ne 's/.* UUID=\"\([^"]*\)\".*/\1/p')
    demo_part=$(sgdisk -p $blk_dev | grep -e "$demo_volume_label" | awk '{print $1}')

    # Standard SONiC approach: Single partition with multiple image directories
    # sonic_image_1 = current/new image
    # sonic_image_2 = previous image (for rollback)

    if [ "$install_env" = "onie" ] || [ "$install_env" = "build" ]; then
        # First installation - use -f flag to force write even if env not initialized
        echo "First installation: Setting up boot configuration for image directory: $image_dir"
        FW_ARG="-f"

        fw_setenv ${FW_ARG} image_dir_old "" > /dev/null
        fw_setenv ${FW_ARG} fit_name_old "" > /dev/null
        fw_setenv ${FW_ARG} sonic_version_2 "None" > /dev/null
        fw_setenv ${FW_ARG} linuxargs_old "" > /dev/null
    else
        # Upgrade scenario - save current image as "old" (image_2)
        echo "Upgrade installation: Saving current image as backup"

        CURR_SONIC_IMAGE="$(sonic-installer list | grep "Current: " | cut -f2 -d' ')"
        FIRST_SONIC_IMAGE="$(fw_printenv sonic_version_1 2>/dev/null | cut -f2 -d'=')"

        echo "Current image: $CURR_SONIC_IMAGE"
        echo "First image (sonic_version_1): $FIRST_SONIC_IMAGE"

        if [ "$CURR_SONIC_IMAGE" = "$FIRST_SONIC_IMAGE" ]; then
            # Current image is image_1, so save it as image_2
            image_dir_old=$(fw_printenv -n image_dir 2>/dev/null || true)
            fit_name_old=$(fw_printenv -n fit_name 2>/dev/null || true)
            sonic_version_2=$(fw_printenv -n sonic_version_1 2>/dev/null || true)
            linuxargs_old=$(fw_printenv -n linuxargs 2>/dev/null || true)

            echo "Saving old image to slot 2: $sonic_version_2"
            fw_setenv ${FW_ARG} image_dir_old "$image_dir_old" || echo "ERROR: Failed to set image_dir_old"
            fw_setenv ${FW_ARG} fit_name_old "$fit_name_old" || echo "ERROR: Failed to set fit_name_old"
            fw_setenv ${FW_ARG} sonic_version_2 "$sonic_version_2" || echo "ERROR: Failed to set sonic_version_2"
            fw_setenv ${FW_ARG} linuxargs_old "$linuxargs_old" || echo "ERROR: Failed to set linuxargs_old"
        else
            echo "Current image does not match first image, skipping backup"
        fi
    fi

    # Set current image variables (image_1)
    echo "Setting sonic_version_1 to: $demo_volume_revision_label"
    echo "DEBUG: About to run fw_setenv commands..."
    echo "DEBUG: FW_ARG=$FW_ARG"
    echo "DEBUG: /etc/fw_env.config contents:"
    cat /etc/fw_env.config || echo "ERROR: Cannot read /etc/fw_env.config"

    fw_setenv ${FW_ARG} image_dir "$image_dir" || echo "ERROR: Failed to set image_dir"
    echo "DEBUG: Set image_dir, checking..."
    fw_printenv image_dir || echo "ERROR: Cannot read image_dir"

    fw_setenv ${FW_ARG} fit_name "$fit_name" || echo "ERROR: Failed to set fit_name"
    fw_setenv ${FW_ARG} sonic_version_1 "$demo_volume_revision_label" || echo "ERROR: Failed to set sonic_version_1"
    echo "DEBUG: Set sonic_version_1, checking..."
    fw_printenv sonic_version_1 || echo "ERROR: Cannot read sonic_version_1"

    # Boot menu with instructions
    BORDER='echo "===================================================";'
    TITLE='echo "SONiC Boot Menu";'
    BOOT1='echo "To boot $sonic_version_1";echo "  type: run sonic_image_1";echo "  at the U-Boot prompt after interrupting U-Boot when it says";echo "  \"Hit any key to stop autoboot:\" during boot";echo;'
    BOOT2='echo "To boot $sonic_version_2";echo "  type: run sonic_image_2";echo "  at the U-Boot prompt after interrupting U-Boot when it says";echo "  \"Hit any key to stop autoboot:\" during boot";echo;'
    FOOTER='echo "===================================================";'
    fw_setenv ${FW_ARG} print_menu "$BORDER $TITLE $BORDER $BOOT1 $BOOT2 $FOOTER" > /dev/null

    # Boot arguments for current image (linuxargs contains loop path)
    fw_setenv ${FW_ARG} linuxargs "console=ttyS12,115200n8 $EARLYCON loopfstype=squashfs loop=$image_dir/$FILESYSTEM_SQUASHFS varlog_size=$VAR_LOG" > /dev/null

    # Boot commands - always load from partition 1 (SONiC-OS)
    DISK_LOAD='ext4load mmc 0:1 ${loadaddr} $fit_name'
    BOOTARGS='setenv bootargs root=UUID='$uuid' rw rootwait panic=1 ${linuxargs}'
    SONIC_BOOT_CMD='run sonic_bootargs; run sonic_boot_load; bootm ${loadaddr}'"$fit_conf_name"

    # Old image boot commands
    sonic_bootargs_old='setenv bootargs root=UUID='$uuid' rw rootwait panic=1 ${linuxargs_old}'
    DISK_LOAD_OLD='ext4load mmc 0:1 ${loadaddr} $fit_name_old'
    SONIC_BOOT_CMD_OLD='run sonic_bootargs_old; run sonic_boot_load_old; bootm ${loadaddr}'"$fit_conf_name"

    # Set U-Boot variables
    fw_setenv ${FW_ARG} sonic_boot_load "$DISK_LOAD" > /dev/null
    fw_setenv ${FW_ARG} sonic_boot_load_old "$DISK_LOAD_OLD" > /dev/null
    fw_setenv ${FW_ARG} sonic_bootargs "$BOOTARGS" > /dev/null
    fw_setenv ${FW_ARG} sonic_bootargs_old "$sonic_bootargs_old" > /dev/null
    fw_setenv ${FW_ARG} sonic_image_1 "$SONIC_BOOT_CMD" > /dev/null
    fw_setenv ${FW_ARG} sonic_image_2 "$SONIC_BOOT_CMD_OLD" > /dev/null
    fw_setenv ${FW_ARG} boot_next 'run sonic_image_1' > /dev/null
    fw_setenv ${FW_ARG} bootcmd 'run print_menu; test -n "$boot_once" && setenv do_boot_once "$boot_once" && setenv boot_once "" && saveenv && run do_boot_once; run boot_next' > /dev/null

    # Set memory addresses (used by manual boot if needed)
    fw_setenv ${FW_ARG} loadaddr $fit_addr > /dev/null
    fw_setenv ${FW_ARG} kernel_addr $kernel_addr > /dev/null
    fw_setenv ${FW_ARG} fdt_addr $fdt_addr > /dev/null
    fw_setenv ${FW_ARG} initrd_addr $initrd_addr > /dev/null

    # Display installation summary
    echo ""
    echo "========================================="
    echo "SONiC Installation Complete"
    echo "========================================="
    echo "Installed to: Partition $demo_part ($demo_volume_label)"
    echo "Image: $demo_volume_revision_label"
    echo ""

    if [ "$install_env" != "onie" ] && [ "$install_env" != "build" ]; then
        # Get current U-Boot variables for display
        UBOOT_VERSION_1=$(fw_printenv -n sonic_version_1 2>/dev/null || echo "None")
        UBOOT_VERSION_2=$(fw_printenv -n sonic_version_2 2>/dev/null || echo "None")

        echo "Dual-boot configuration:"
        echo "  - Image 1 (sonic_version_1): $UBOOT_VERSION_1"
        echo "  - Image 2 (sonic_version_2): $UBOOT_VERSION_2"
        echo "  - Next boot: Image 1"
        echo ""
        echo "To switch to backup image, run:"
        echo "  sonic-installer set-default $UBOOT_VERSION_2"
        echo ""
    fi

    echo "U-Boot configuration updated successfully"
    echo "========================================="
}

# Configure bootloader menu
bootloader_menu_config() {
    # In "build" mode (creating raw image), we can't access U-Boot environment
    # Skip U-Boot configuration in this case
    if [ "$install_env" = "build" ]; then
        echo "Build mode: Skipping U-Boot environment configuration"
        echo "U-Boot environment will be configured on first boot"

        # Sync to flush all writes
        sync

        # Convert demo_mnt to absolute path before changing directory
        # (demo_mnt is a relative path like "build_raw_image_mnt")
        demo_mnt_abs=$(realpath "$demo_mnt")

        # Change back to root directory BEFORE unmounting (critical for cleanup)
        cd /

        # Unmount the raw image using absolute path
        umount "$demo_mnt_abs" || {
            echo "Warning: Failed to unmount $demo_mnt_abs"
            # Try lazy unmount as fallback
            umount -l "$demo_mnt_abs" || true
        }

        echo "Installed SONiC base image $demo_volume_label successfully"
        return 0
    fi

    # Update U-Boot Environment for ONIE or SONiC installation
    prepare_boot_menu
}

